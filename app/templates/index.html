<!--
    index.html - Career Recommendation Engine

    This HTML file implements a RIASEC-based career interest survey and recommendation system.
    It provides a multi-step survey interface, collects user responses, and displays personalized
    career recommendations with interactive charts and a chat-based AI career advisor.

    Main Features:
    - Responsive, styled UI for a 48-question RIASEC survey (Realistic, Investigative, Artistic, Social, Enterprising, Conventional).
    - Multi-step navigation with progress bar, validation, and animated transitions.
    - Dynamic rendering of survey questions and preservation of user answers between steps.
    - On completion, submits answers to a backend API (/recommend) and displays:
        - RIASEC profile radar chart and top job matches bar chart (images from backend).
        - Table of recommended occupations with similarity scores and expandable details (knowledge, skills, abilities).
    - Integrated chat interface ("OccumendAI") for follow-up questions, sending user profile summary and queries to backend (/chat).
    - Accessible, mobile-friendly design with clear feedback and error handling.

    Key JavaScript Functions:
    - renderStep(stepIndex): Renders the current survey step/questions.
    - updateUI(): Updates progress bar and navigation buttons.
    - validateStep(): Ensures all questions in the current step are answered.
    - goToNext()/goToBack(): Handles navigation with fade transitions.
    - submitAndShowResults(): Submits answers, handles API response, and renders results.
    - renderResults(data, answersForBackend): Displays charts, recommendations, and initializes chat.
    - toggleDetails(rowIndex): Expands/collapses occupation details in the results table.
    - addChatMessage(message, className): Appends messages to the chat interface.

    Dependencies:
    - marked.js (for Markdown rendering in chat responses)
    - Backend endpoints: /recommend (POST), /chat (POST)
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Recommendation Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
            line-height: 1.6;
        }

        h1,
        h2,
        h3 {
            text-align: center;
        }

        h1 {
            border-bottom: 2px solid teal;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        h2 {
            border-top: 2px solid #eee;
            padding-top: 40px;
            margin-top: 40px;
        }

        button {
            background-color: teal;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s, opacity 0.3s;
        }

        button:hover {
            background-color: #006666;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #results {
            margin-top: 40px;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        #results.visible {
            opacity: 1;
        }

        .form-container {
            opacity: 1;
            transition: opacity 0.4s ease-in-out;
        }

        .form-container.fade-out {
            opacity: 0;
        }

        .survey-table {
            width: 100%;
            border-collapse: collapse;
        }

        .survey-table th,
        .survey-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .survey-table th {
            background-color: #f2f2f2;
            font-size: 14px;
        }

        .survey-table td:first-child {
            text-align: left;
            width: 60%;
        }

        .survey-table input[type="radio"] {
            cursor: pointer;
            transform: scale(1.2);
        }

        .question-error {
            border: 2px solid #d9534f !important;
            border-radius: 5px;
        }

        .cat-r {
            background-color: #e7f3e8;
        }

        .cat-i {
            background-color: #e9e7f3;
        }

        .cat-a {
            background-color: #fef8e2;
        }

        .cat-s {
            background-color: #f3e7f3;
        }

        .cat-e {
            background-color: #f8eee5;
        }

        .cat-c {
            background-color: #e5f1f8;
        }

        #survey-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        #survey-navigation button {
            width: 120px;
        }

        #nav-back {
            background-color: #6c757d;
        }

        #nav-back:hover {
            background-color: #5a6268;
        }

        #validation-message {
            color: #d9534f;
            font-weight: bold;
            visibility: hidden;
        }

        #progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            margin: 30px 0;
        }

        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: teal;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.4s ease-in-out;
        }

        .charts-container {
            display: flex;
            gap: 40px;
            margin-top: 30px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            max-width: 45%;
            text-align: center;
        }

        .chart-wrapper img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }

        .results-table th {
            background-color: #f2f2f2;
        }

        .details-btn {
            background-color: #555;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .details-btn:hover {
            background-color: #333;
        }

        .details-row>td {
            padding: 0 !important;
        }

        .details-content {
            background-color: #fafafa;
            padding: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .details-content h4 {
            margin-top: 0;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        .details-content ul {
            margin: 0;
            padding-left: 20px;
        }

        .details-content>div {
            flex: 1;
            min-width: 200px;
        }

        .hidden {
            display: none;
        }

        #chat-container {
            margin-top: 50px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        #chat-header {
            background-color: #f5f5f5;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        #chat-header h2 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 18px;
            text-align: left;
        }

        #chat-messages {
            height: auto;
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 10px 16px;
            border-radius: 20px;
            max-width: 85%;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .user-message {
            background-color: teal;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background-color: #f1f1f1;
            color: black;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        #chat-form-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }

        #chat-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #chat-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            resize: none;
            overflow-y: hidden;
            min-height: 24px;
            line-height: 1.5;
        }

        #chat-form button {
            width: auto;
            font-size: 16px;
            padding: 10px 15px;
            flex-shrink: 0;
            align-self: center;
        }
    </style>
</head>

<body>

    <h1>Career Interest Survey</h1>

    <div id="riasec-form-container" class="form-container">
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
        <form id="riasec-form" novalidate>
            <table class="survey-table">
                <thead>
                    <tr>
                        <th>Activity</th>
                        <th>Dislike</th>
                        <th>Slightly Dislike</th>
                        <th>Neutral</th>
                        <th>Slightly Enjoy</th>
                        <th>Enjoy</th>
                    </tr>
                </thead>
                <tbody id="survey-body">
                    <!-- Questions will be dynamically inserted here -->
                </tbody>
            </table>
        </form>
        <div id="survey-navigation">
            <button id="nav-back">Back</button>
            <span id="validation-message">Please answer all questions.</span>
            <button id="nav-next">Next</button>
        </div>
    </div>

    <div id="results"></div>

    <div id="chat-container" class="hidden">
        <div id="chat-header">
            <h2>Chat with Your Career Advisor</h2>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-form-container">
            <form id="chat-form">
                <textarea id="chat-input" placeholder="Ask a follow-up, e.g., 'Which of these is less stressful?'"
                    rows="1"></textarea>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. CONSTANTS AND VARIABLES ---
        const questions = [
            { cat: 'R', text: 'Test the quality of parts before shipment' }, { cat: 'R', text: 'Lay brick or tile' }, { cat: 'R', text: 'Work on an offshore oil-drilling rig' }, { cat: 'R', text: 'Assemble electronic parts' }, { cat: 'R', text: 'Operate a grinding machine in a factory' }, { cat: 'R', text: 'Fix a broken faucet' }, { cat: 'R', text: 'Assemble products in a factory' }, { cat: 'R', text: 'Install flooring in houses' },
            { cat: 'I', text: 'Study the structure of the human body' }, { cat: 'I', text: 'Study animal behavior' }, { cat: 'I', text: 'Do research on plants or animals' }, { cat: 'I', text: 'Develop a new medical treatment or procedure' }, { cat: 'I', text: 'Conduct biological research' }, { cat: 'I', text: 'Study whales and other types of marine life' }, { cat: 'I', text: 'Work in a biology lab' }, { cat: 'I', text: 'Make a map of the bottom of an ocean' },
            { cat: 'A', text: 'Conduct a musical choir' }, { cat: 'A', text: 'Direct a play' }, { cat: 'A', text: 'Design artwork for magazines' }, { cat: 'A', text: 'Write a song' }, { cat: 'A', text: 'Write books or plays' }, { cat: 'A', text: 'Play a musical instrument' }, { cat: 'A', text: 'Perform stunts for a movie or television show' }, { cat: 'A', text: 'Design sets for plays' },
            { cat: 'S', text: 'Give career guidance to people' }, { cat: 'S', text: 'Do volunteer work at a non-profit organization' }, { cat: 'S', text: 'Help people who have problems with drugs or alcohol' }, { cat: 'S', text: 'Teach an individual an exercise routine' }, { cat: 'S', text: 'Help people with family-related-problems' }, { cat: 'S', text: 'Supervise the activities of children at a camp' }, { cat: 'S', text: 'Teach children how to read' }, { cat: 'S', text: 'Help elderly people with their daily activities' },
            { cat: 'E', text: 'Sell restaurant franchises to individuals' }, { cat: 'E', text: 'Sell merchandise at a department store' }, { cat: 'E', text: 'Manage the operations of a hotel' }, { cat: 'E', text: 'Operate a beauty salon or barber shop' }, { cat: 'E', text: 'Manage a department within a large company' }, { cat: 'E', text: 'Manage a clothing store' }, { cat: 'E', text: 'Sell houses' }, { cat: 'E', text: 'Run a toy store' },
            { cat: 'C', text: 'Generate the monthly payroll checks for an office' }, { cat: 'C', text: 'Inventory supplies using a hand-held computer' }, { cat: 'C', text: 'Use a computer program to generate customer bills' }, { cat: 'C', text: 'Maintain employee records' }, { cat: 'C', text: 'Compute and record statistical and other numerical data' }, { cat: 'C', text: 'Operate a calculator' }, { cat: 'C', text: 'Handle customers\' bank transactions' }, { cat: 'C', text: 'Keep shipping and receiving records' }
        ];

        const steps = ['R', 'I', 'A', 'S', 'E', 'C'];
        let currentStep = 0;
        let userAnswers = {}; // Store all answers

        const surveyBody = document.getElementById('survey-body');
        const backBtn = document.getElementById('nav-back');
        const nextBtn = document.getElementById('nav-next');
        const progressBar = document.getElementById('progress-bar');
        const validationMsg = document.getElementById('validation-message');
        const formContainer = document.getElementById('riasec-form-container');
        const resultsContainer = document.getElementById('results');

        let userProfileSummary = '';
        let recommendationsData = [];

        // --- 2. FUNCTIONS ---

        function renderStep(stepIndex) {
            const category = steps[stepIndex];
            const stepQuestions = questions.filter(q => q.cat === category);

            surveyBody.innerHTML = '';
            stepQuestions.forEach(q => {
                const qIndex = questions.indexOf(q);
                const row = document.createElement('tr');
                row.className = `cat-${q.cat.toLowerCase()}`;
                row.id = `q-row-${qIndex}`;

                let rowHTML = `<td>${q.text}</td>`;
                for (let i = 1; i <= 5; i++) {
                    const isChecked = userAnswers[qIndex] === i.toString() ? 'checked' : '';
                    rowHTML += `<td><input type="radio" name="q${qIndex}" value="${i}" data-q-index="${qIndex}" ${isChecked}></td>`;
                }
                row.innerHTML = rowHTML;
                surveyBody.appendChild(row);
            });
            updateUI();
        }

        function updateUI() {
            const progress = (currentStep / steps.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;

            backBtn.style.visibility = currentStep === 0 ? 'hidden' : 'visible';
            nextBtn.textContent = currentStep === steps.length - 1 ? 'Get Results' : 'Next';
        }

        function validateStep() {
            const currentQuestions = questions.filter(q => q.cat === steps[currentStep]);
            let allAnswered = true;
            validationMsg.style.visibility = 'hidden';

            currentQuestions.forEach(q => {
                const qIndex = questions.indexOf(q);
                const row = document.getElementById(`q-row-${qIndex}`);
                row.classList.remove('question-error');

                if (!userAnswers[qIndex]) {
                    allAnswered = false;
                    row.classList.add('question-error');
                }
            });

            if (!allAnswered) {
                validationMsg.style.visibility = 'visible';
            }
            return allAnswered;
        }

        async function goToNext() {
            if (!validateStep()) return;

            if (currentStep < steps.length - 1) {
                currentStep++;
                await fadeTransition(renderStep, currentStep);
            } else {
                await submitAndShowResults();
            }
        }

        async function goToBack() {
            if (currentStep > 0) {
                currentStep--;
                await fadeTransition(renderStep, currentStep);
            }
        }

        function fadeTransition(updateFunction, ...args) {
            return new Promise(resolve => {
                formContainer.classList.add('fade-out');
                setTimeout(() => {
                    updateFunction(...args);
                    formContainer.classList.remove('fade-out');
                    resolve();
                }, 400);
            });
        }

        async function submitAndShowResults() {
            nextBtn.disabled = true;
            nextBtn.textContent = "Calculating...";

            // Hide the form and show the loading screen
            formContainer.classList.add('fade-out');
            setTimeout(() => {
                formContainer.style.display = 'none';
                resultsContainer.innerHTML = '<h2>Calculating Results...</h2>';
                resultsContainer.classList.add('visible');
            }, 400);

            // Prepare data for API call
            const answersForBackend = { R: [], I: [], A: [], S: [], E: [], C: [] };
            for (const qIndex in userAnswers) {
                const category = questions[qIndex].cat;
                answersForBackend[category].push(parseInt(userAnswers[qIndex]));
            }

            try {
                // API call (after animation finishes)
                await new Promise(resolve => setTimeout(resolve, 450)); // Animasyonun bitmesini bekle
                const response = await fetch('/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(answersForBackend),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                renderResults(data, answersForBackend);

            } catch (error) {
                resultsContainer.innerHTML = '<h2>An error occurred. Please try again.</h2>';
                console.error('Error:', error);
            }
        }

        function renderResults(data, answersForBackend) {
            recommendationsData = data.recommendations;

            const riasecScores = {};
            for (const cat in answersForBackend) {
                const scores = answersForBackend[cat];
                riasecScores[cat] = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2) : 0;
            }
            const topJobs = recommendationsData.slice(0, 3).map(rec => rec.Title).join(', ');
            userProfileSummary = `My RIASEC interest scores are: Realistic: ${riasecScores.R}, Investigative: ${riasecScores.I}, Artistic: ${riasecScores.A}, Social: ${riasecScores.S}, Enterprising: ${riasecScores.E}, Conventional: ${riasecScores.C}. The top recommended jobs for me were: ${topJobs}.`;

            let html = '<h2>Your Results</h2>';
            html += `<div class="charts-container">...</div>`;
            html += '<h3>Recommendations List</h3><table class="results-table">...</table>';

            // Build the full HTML
            let resultsHtml = '<h2>Your Results</h2>';
            resultsHtml += `
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3>Your Interest Profile</h3>
                        <img src="${data.chart_images.radar}" alt="Your Interest Profile Radar Chart">
                    </div>
                    <div class="chart-wrapper">
                        <h3>Top Job Matches</h3>
                        <img src="${data.chart_images.bar}" alt="Top Job Matches Bar Chart">
                    </div>
                </div>
            `;
            resultsHtml += '<h3>Recommendations List</h3><table class="results-table"><thead><tr><th>Occupation</th><th>Career Cluster</th><th>Similarity</th><th>Details</th></tr></thead><tbody>';
            recommendationsData.forEach((rec, index) => {
                resultsHtml += `
                    <tr class="result-row">
                        <td>${rec.Title}</td>
                        <td>${rec.cluster_name}</td>
                        <td>${(rec.similarity * 100).toFixed(2)}%</td>
                        <td><button class="details-btn" onclick="toggleDetails(${index})">Details</button></td>
                    </tr>
                    <tr id="details-row-${index}" class="details-row hidden"><td colspan="4">
                        <div class="details-content">
                            <div><h4>Top 5 Required Knowledge</h4><ul>${rec.knowledge.map(item => `<li>${item}</li>`).join('') || '<li>N/A</li>'}</ul></div>
                            <div><h4>Top 5 Required Skills</h4><ul>${rec.skills.map(item => `<li>${item}</li>`).join('') || '<li>N/A</li>'}</ul></div>
                            <div><h4>Top 5 Required Abilities</h4><ul>${rec.abilities.map(item => `<li>${item}</li>`).join('') || '<li>N/A</li>'}</ul></div>
                        </div>
                    </td></tr>`;
            });
            resultsHtml += '</tbody></table>';

            resultsContainer.innerHTML = resultsHtml;
            document.getElementById('chat-container').classList.remove('hidden');
            addChatMessage("Hello! I'm your AI career advisor OccumendAI. Feel free to ask me anything about your results or the recommended jobs.", "bot-message");
        }

        // --- 3. EVENT LISTENERS ---

        nextBtn.addEventListener('click', goToNext);
        backBtn.addEventListener('click', goToBack);

        surveyBody.addEventListener('change', event => {
            if (event.target.type === 'radio') {
                const qIndex = event.target.getAttribute('data-q-index');
                userAnswers[qIndex] = event.target.value;
                const row = document.getElementById(`q-row-${qIndex}`);
                if (row.classList.contains('question-error')) {
                    row.classList.remove('question-error');
                    if (document.querySelectorAll('.question-error').length === 0) {
                        validationMsg.style.visibility = 'hidden';
                    }
                }
            }
        });

        document.getElementById('riasec-form').addEventListener('submit', e => e.preventDefault());

        // --- Initial Load ---
        renderStep(currentStep);

        function toggleDetails(rowIndex) {
            const detailsRow = document.getElementById(`details-row-${rowIndex}`);
            if (detailsRow) {
                detailsRow.classList.toggle('hidden');
            }
        }
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        chatInput.addEventListener('input', function () { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        chatForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const userQuestion = chatInput.value.trim(); if (!userQuestion) return;
            addChatMessage(userQuestion, 'user-message');
            chatInput.value = ''; chatInput.style.height = 'auto';
            const typingIndicator = addChatMessage("Typing...", 'bot-message');
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: userQuestion, profile_summary: userProfileSummary }),
                });
                const data = await response.json();
                typingIndicator.remove();
                if (data.answer) { addChatMessage(data.answer, 'bot-message'); }
                else { addChatMessage(data.error || 'Sorry, something went wrong.', 'bot-message'); }
            } catch (error) {
                typingIndicator.remove();
                addChatMessage('I seem to be having trouble connecting. Please try again later.', 'bot-message');
            }
        });
        function addChatMessage(message, className) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${className}`;
            if (className === 'bot-message') { messageElement.innerHTML = marked.parse(message); }
            else { messageElement.textContent = message; }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageElement;
        }
    </script>

</body>

</html>